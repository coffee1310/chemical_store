{% extends 'app/base.html' %}
{% load static %}

{% block content %}
{% for c in category %}

<p class="category">{{c.cat}}</p>
<div class="products">

		{% for p in products %}
		{% if p.cat == c %}
			<div class="product">
				<p class="product-img"><img src="{{p.product_image.url}}"></p>
				<span class="product-name">{{p.product_name}}</span>
				<div class="stroke"></div>
				<span class="product-price">{{p.product_price}}₽</span>
				<div class="count">
					<button onclick="reduceValue('counter{{p.pk}}')">-</button>
					<span id="counter{{p.pk}}">1</span>
					
					<button onclick="increaseValue('counter{{p.pk}}')">+</button>
				</div>
				<button class="add-to-cart" data-product-id="{{ p.id }}">Купить</button>
			</div>
		{% endif %}
		{% endfor %}


</div>
{% endfor %}
<script src="{% static 'app/js/main.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const addToCartButtons = document.querySelectorAll('.add-to-cart');
    addToCartButtons.forEach(button => {
        button.addEventListener('click', addToCart);
    });

    function addToCart(event) {
        const productId = event.target.dataset.productId;
        const url = `/cart/add_ajax/${productId}/`;

        // Получение CSRF-токена из cookie
        const csrftoken = getCookie('csrftoken');

        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken // Передача CSRF-токена в заголовке
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data.message);
            // Обновите информацию о корзине без перезагрузки страницы, если требуется
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // Функция для получения CSRF-токена из cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Имя cookie начинается с 'csrftoken='
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}


{% block search %}
<form method="{{method}}">
	<ul>
		{% csrf_token %}
		<li>{{ search_form.as_p }}</li>
		<li class="search-btn"><button><img src="{% static 'app/images/search.png' %}"></button></li>
	</ul>
</form>
{% endblock %}